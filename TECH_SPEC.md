# Havoc Technical Specification

## Tech Stack

### Backend
- **Runtime:** Node.js 20+
- **Framework:** Fastify
- **AI/LLM:** Google Gemini (via @google/genai)
- **Queue:** Inline processing (BullMQ optional for scale)
- **Database:** SQLite (single file, zero config, scales to Turso later)

### GitHub Integration
- **Auth:** GitHub App (OAuth + Installation tokens)
- **API:** Octokit (official GitHub SDK)
- **Webhooks:** Issue events, PR events, Check runs

### Sandbox Environment
- **Isolation:** Docker containers per run
- **File System:** Ephemeral volume, destroyed after run
- **Timeouts:** Max 10 min per run, max 50 iterations
- **Command Allowlist:** git, npm, yarn, pnpm, pytest, go test, cargo test

### Frontend (Optional Dashboard)
- **Framework:** Next.js 14+ or SvelteKit
- **Styling:** Tailwind CSS
- **Auth:** GitHub OAuth

---

## Example Intent Card

```markdown
# Intent Card

## Issue Summary
Fix the login button not responding on mobile devices (#142)

## Scope and Assumptions
- Bug is isolated to mobile viewport (<768px)
- No backend changes required
- Existing test suite covers desktop behavior

## Planned Approach
1. Investigate click handler binding on LoginButton component
2. Check for CSS pointer-events or z-index issues
3. Add touch event handling if needed
4. Write mobile-specific test case

## Files Changed
| File | Change | Rationale |
|------|--------|-----------|
| src/components/LoginButton.tsx | Added onTouchStart handler | Mobile Safari requires explicit touch events |
| src/components/LoginButton.css | Fixed z-index stacking | Modal overlay was blocking clicks |
| tests/LoginButton.mobile.test.tsx | New file | Covers mobile touch interaction |

## Tests Added
- `should respond to touch on mobile viewport` - verifies fix
- `should maintain focus state after touch` - edge case

## Risk Assessment
- **Low:** Change is isolated to one component
- **Low:** No API or state management changes
- **Medium:** Touch events may behave differently on older iOS

## Confidence Score: 87%

| Signal | Score | Weight | Contribution |
|--------|-------|--------|--------------|
| Tests passing | 100% | 30% | 30 |
| Lint clean | 100% | 10% | 10 |
| Change complexity | 85% | 20% | 17 |
| Dependency risk | 100% | 15% | 15 |
| Behavior risk | 75% | 15% | 11 |
| Self-review | 80% | 10% | 8 |

## Self-Review Notes
- Considered using a library like react-use-gesture but decided native events are sufficient
- The z-index fix may need review if other modals are added later
- Recommend manual QA on physical iOS device before merge
```

---

## Example PR Structure

```
PR Title: fix: login button not responding on mobile (#142)

PR Body:
## Summary
This PR fixes the mobile login button issue reported in #142.

## Intent Card
[Full Intent Card embedded or linked]

## Changes
- 2 files modified
- 1 file added
- 47 lines changed

## Test Results
✅ 24/24 tests passing
✅ Lint clean
✅ Type check clean

## Confidence Score: 87%
See breakdown in Intent Card.

## Self-Review
[Reviewer Notes section with findings]

## How to Test
1. Open app on mobile device or Chrome DevTools mobile view
2. Navigate to /login
3. Tap the login button
4. Verify modal opens correctly

---
Generated by Havoc | [View Run](https://usehavoc.dev/runs/abc123)
```

---

## API Endpoints

### Trigger Run
```
POST /api/runs
{
  "repo": "owner/repo",
  "issue_number": 142,
  "template": "bugfix"  // optional: bugfix | feature | refactor
}
```

### Get Run Status
```
GET /api/runs/:run_id
→ { status, progress, artifacts, pr_url }
```

### Get Intent Card
```
GET /api/runs/:run_id/intent-card
→ Markdown content
```

### Webhook Receiver
```
POST /webhooks/github
← Issue labeled, comment created, etc.
```

---

## Data Models

### Run
```typescript
interface Run {
  id: string
  repo: string
  issue_number: number
  status: 'pending' | 'cloning' | 'analyzing' | 'planning' | 'editing' | 'testing' | 'reviewing' | 'publishing' | 'done' | 'failed'
  started_at: Date
  completed_at: Date | null
  artifacts: {
    plan: string       // JSON
    intent_card: string // Markdown
    review: string     // Markdown
    confidence: number
    pr_url: string | null
  }
  error: string | null
}
```

### Config (.havoc.yaml)
```yaml
version: 1

# Run settings
max_iterations: 50
timeout_minutes: 10

# Test commands (auto-detected if not specified)
test_command: npm test

# Policy gates
min_confidence: 70
min_test_pass_rate: 90

# Command allowlist (defaults shown)
allowed_commands:
  - git
  - npm
  - yarn
  - pnpm
  - node
  - npx
  - pytest
  - python
  - go
  - cargo

# Files to never edit
protected_files:
  - .env
  - .env.*
  - "*.key"
  - "*.pem"
  - secrets.*
```

---

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                        GitHub                                │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐                  │
│  │  Issue  │───▶│ Webhook │───▶│   PR    │                  │
│  └─────────┘    └────┬────┘    └─────────┘                  │
└──────────────────────┼──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                      Havoc Backend                            │
│                                                              │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐   │
│  │ Orchestrator │───▶│   Planner    │───▶│ Code Editor  │   │
│  └──────────────┘    └──────────────┘    └──────────────┘   │
│         │                                       │            │
│         │            ┌──────────────┐           │            │
│         │            │  LLM (Claude)│◀──────────┤            │
│         │            └──────────────┘           │            │
│         │                                       ▼            │
│         │            ┌──────────────┐    ┌──────────────┐   │
│         └───────────▶│   Reviewer   │◀───│ Test Runner  │   │
│                      └──────────────┘    └──────────────┘   │
│                             │                               │
│                             ▼                               │
│                      ┌──────────────┐                       │
│                      │ PR Publisher │                       │
│                      └──────────────┘                       │
└─────────────────────────────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    Sandbox (Docker)                          │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Cloned Repo │ Edits │ Tests │ Artifacts            │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

---

## Roadmap

### Phase 1: Hackathon MVP ✅ COMPLETE
- [x] Issue → Plan → Code → Test → PR pipeline
- [x] Intent Card generation
- [x] Confidence score (6 signals)
- [x] GitHub App webhook receiver
- [x] CLI tool (havoc run, server, status, init)

### Phase 2: Beta ✅ COMPLETE
- [x] Self-review agent
- [ ] Ask-the-PR chat
- [ ] Dashboard with run history
- [x] Multiple repo support
- [x] Config file support (.havoc.yaml)

### Phase 3: Launch (Next)
- [x] Policy gates (confidence threshold, test pass rate)
- [ ] Team/org management
- [ ] Audit logs
- [ ] GitHub Action for scheduled runs
- [ ] Slack/Teams notifications

### Phase 4: Enterprise (Month 4-6)
- [ ] SSO (SAML/OIDC)
- [ ] On-prem deployment option
- [ ] Compliance exports (SOC2, etc.)
- [ ] Custom LLM support (Azure OpenAI, self-hosted)
- [ ] Advanced analytics

---

## Team

| Role | Responsibility |
|------|----------------|
| **Tech Lead** | Architecture, LLM integration, orchestrator |
| **Backend** | GitHub API, webhooks, sandbox, queue |
| **Frontend** | Dashboard, GitHub App UI |
| **DevOps** | Docker, deployment, CI/CD |

---

## Risks and Mitigations

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| LLM generates broken code | High | Medium | Self-review + test gate before PR |
| Sandbox escape | Critical | Low | Docker isolation, command allowlist, no network in sandbox |
| GitHub API rate limits | Medium | Medium | Caching, token rotation, backoff |
| Long run times | Medium | Medium | Timeout limits, iteration caps |
| LLM costs explode | High | Medium | Token budgets per run, caching common patterns |
| Wrong file edited | High | Low | Protected files config, git diff review |

---

## Success Metrics

### Hackathon
- [ ] Live demo works end-to-end
- [ ] PR is actually created on GitHub
- [ ] Intent Card is readable and useful
- [ ] Judges understand the value in <30 seconds

### Post-Launch
- **Adoption:** # of repos installed
- **Engagement:** # of runs per week
- **Quality:** % of PRs merged without changes
- **Trust:** Average confidence score
- **Revenue:** MRR from Pro/Enterprise

---

## Demo Repo Setup

### Repository: `usehavoc/demo-app`

A simple Express.js TODO app with:
- Basic CRUD endpoints
- Existing test suite (Jest)
- Known bugs to fix
- Missing features to add

### Sample Issues

**Issue #1: Bug**
```
Title: Login endpoint returns 500 when email is missing
Body: When POST /login is called without an email field, the server crashes instead of returning a 400 error.
```

**Issue #2: Feature**
```
Title: Add rate limiting to API endpoints
Body: We need to add rate limiting (100 req/min per IP) to prevent abuse. Should return 429 when limit is exceeded.
```

**Issue #3: Refactor**
```
Title: Extract validation logic into middleware
Body: The validation code is duplicated across multiple routes. Extract it into reusable middleware.
```

---

## Local Development

```bash
# Clone
git clone https://github.com/usehavoc/havoc
cd havoc

# Install
npm install

# Environment
cp env.example .env
# Add: GEMINI_API_KEY, GITHUB_TOKEN

# Build
npm run build

# Build sandbox image
docker build -t havoc-sandbox -f docker/Dockerfile.sandbox .

# Run CLI
npx havoc run https://github.com/owner/repo/issues/42

# Or start server
npx havoc server
```

---

## Environment Variables

```bash
# Server
PORT=3000
HOST=0.0.0.0

# GitHub App
GITHUB_APP_ID=123456
GITHUB_PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----\n..."
GITHUB_WEBHOOK_SECRET=your_webhook_secret
GITHUB_TOKEN=ghp_your_personal_access_token  # For CLI mode

# LLM
GEMINI_API_KEY=your_gemini_api_key

# Database (SQLite)
DATABASE_PATH=./data/havoc.db

# Sandbox
SANDBOX_IMAGE=havoc-sandbox
SANDBOX_TIMEOUT=600000
WORKSPACE_DIR=./workspaces

# Optional
LOG_LEVEL=info
```

---

## License

MIT (for OSS version)
Commercial license for Enterprise features
